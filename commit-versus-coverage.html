<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v3.min.js"></script>
    <style>
        .axis path,
        .axis line {
            fill: none;
            stroke: #000;
            shape-rendering: crispEdges;
        }

        body {
            font: 10px helvetica;
        }
    </style>
</head>

<body>
    <script>
        // Could refactor this to make it more programmatic
        // 1. Set Margins: Recommended by one of the creators of D3 - https://bl.ocks.org/mbostock/3019563
        var margin = { top: 20, right: 20, bottom: 30, left: 40 };
        var width = 960 - margin.left - margin.right;
        var height = 500 - margin.top - margin.bottom;

        // 2. Create SVG - Scalable Vector Graphics
        // NOTE: Can add more svgs for multiple graphs displayed
        var svg = d3.select("body").append("svg")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // Sets the actual scaling of the bars with regards to x-axis
        var xBar = d3.scale.ordinal().rangeRoundBands([0, width], .2);

        // Sets the scaling of the full x-axis chart
        var xChart = d3.scale.ordinal();
        var y = d3.scale.linear().range([height, 0]);
        var xAxis = d3.svg.axis().scale(xBar).orient("bottom");
        var yAxis = d3.svg.axis().scale(y).orient("left");

        // 4. Set colours of the bars
        var colours = ["#506877", "#f08080", "#5b5048", "#f7ba9b"];
        var color = d3.scale.ordinal().range(colours);


        // 5. Load Data: https://d3-wiki.readthedocs.io/zh_CN/master/CSV/
        d3.csv("viz-test-data/coverageGrouped.csv", function (error, data) {

            // 6. Gets all headers except Commit (can be set manually if needed to). Can to used for column selection.
            var headers = ["Statement Coverage %", "Branch Coverage %", "Function Coverage %", "Line Coverage %"];

            // 7. Map parsed csv values (since they are initially strings) into actual integer values.
            data.forEach(function (d) {
                d.coverage = headers.map(function (type) {
                    return {
                        type: type,
                        value: +d[type]
                    };
                });
            });

            // 8. Common pattern used in many examples for v3 and v4. Set the domain ranges here. 
            // https://jaketrent.com/post/use-d3-rangebands/
            xBar.domain(data.map(function (d) { return d.Commit; }));
            xChart.domain(headers).rangeRoundBands([0, xBar.rangeBand()]);
            y.domain([0, d3.max(data, function (d) { return d3.max(d.coverage, function (d) { return d.value; }); })]);

            // 9. Renders the x-axis
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + height + ")")
                .call(xAxis);

            // 10. Renders the y-axis
            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

            // 11. Formats the title for the label on the y-axis
            svg.append("g")
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", 6)
                .attr("dy", ".71em")
                .style("text-anchor", "end")
                .text("Coverage %");

            // 12. Renders Data in our dataset, with DOM elements being mapped.
            // https://riptutorial.com/d3-js/example/16948/the-role-of-placeholders-in--enter--selections
            var commit = svg.selectAll(".commit")
                .data(data)
                .enter().append("g")
                .attr("class", "g")
                .attr("transform", function (d) { return "translate(" + xBar(d.Commit) + ",0)"; });

            // 13. Optional - Graph animations: https://medium.com/swlh/d3-animated-bar-chart-ede2a10709b                   
            commit.selectAll("rect")
                .data(function (d) { return d.coverage; })
                .enter().append("rect")
                .attr("width", xChart.rangeBand())
                .attr("x", function (d) { return xChart(d.type); })
                .attr("y", function (d) { return y(0); })
                .attr("height", function (d) { return height - y(0); })
                .style("fill", function (d) { return color(d.type); });

            // This controls the animation delay using .transition() along the y-axis
            commit.selectAll("rect")
                .transition()
                .delay(500)
                .duration(1000)
                .attr("y", function (d) { return y(d.value); })
                .attr("height", function (d) { return height - y(d.value); });

            // 14. Render legend: 
            // https://www.howtobuildsoftware.com/index.php/how-do/b8Hi/javascript-d3js-how-to-add-legend-to-an-aster-plot-d3-js
            var legend = svg.selectAll(".legend")
                .data(headers.slice())
                .enter().append("g")
                .attr("class", "legend")
                .attr("transform", function (d, i) { return "translate(0," + i * 20 + ")"; });

            legend.append("rect")
                .attr("x", width)
                .attr("width", 18)
                .attr("height", 18)
                .style("fill", color);

            legend.append("text")
                .attr("x", width - 5)
                .attr("y", 9)
                .attr("dy", ".32em")
                .style("text-anchor", "end")
                .text(function (d) { return d; });
        });


    </script>

</body>

</html>